#!/bin/sh

# $Id: pkgbuild,v 1.1 2002/10/12 01:15:45 unsaved Exp $

# TODO:  Perhaps use RCS keywords to generate versions and write them
#        into the install scripts, the info file, and to use in the
#        stream package file name.

set +u

PROGNAME=`basename "$0"`

Failout() {
    echo "Aborting $PROGNAME.  $@" 1>&2
    exit 1
}

case "`uname`" in
    SunOS)
	echonoterm() {	# Echo without trailing newline
	    echo "$@\c"
	}
    ;;
    Linux)
	echonoterm() {	# Echo without trailing newline
	    echo -n "$@"
	}
    ;;
    *)
    	echo 'Aborting.  Your OS is not supported yet.  If you seriously' 1>&2
	echo "want support for it, email ${AUTHOR_EMAILADDR}."
	exit 10
    ;;
esac

# Being VERY careful here, because we do a relative "rm -rf" below!!
[ $0 = "./$PROGNAME" ] ||
 Failout "You have to run this script like './$PROGNAME'"

[ $# -gt 0 ] && [ "$1" = '-n' ] && {
    pkgmk() {
	echo "pkgmk $@" 1>&2
    }
    pkgtrans() {
	echo "pkgtransmk $@" 1>&2
    }
    compress() {
	echo "compress $@" 1>&2
    }
    rm() {
	echo "rm $@" 1>&2
    }
}

PKGNAME=`sed -n '/^PKG=/ {
    s:^PKG=::
    p
}' cfg/HSQLhsqldb.info` ||
 Failout 'Failed to package name version from info file'
[ -n "$PKGNAME" ] || Failout 'Failed to retrieve package name from info file'
VERINFO=`sed -n '/^VERDIR=/ {
    s:^VERDIR=::
    p
}' cfg/HSQLhsqldb.info` || Failout 'Failed to retrieve version from info file'
[ -n "$VERINFO" ] || Failout 'Failed to retrieve version from info file'
VERPOST=`sed -n '/^BASE=/ {
    s:^BASE=::
    p
}' cfg/HSQLhsqldb.postinstall` ||
 Failout 'Failed to retrieve version from info postinstall script'
[ -n "$VERPOST" ] ||
 Failout 'Failed to retrieve version from info postinstall script'
VERPRE=`sed -n '/^BASE=/ {
    s:^BASE=::
    p
}' cfg/HSQLhsqldb.preremove ` ||
 Failout 'Failed to retrieve version from info preremove script'
[ -n "$VERPRE" ] ||
 Failout 'Failed to retrieve version from info preremove script'

[ "$VERPRE" = "$VERPOST" ] || Failout  \
 "Version specs (BASE) don't agreein preremove script and postinstall script"
[ "$VERPRE" = "$VERINFO" ] || 
 Failout "Version specs (BASE and VERDIR) don't agreein preremove script and 
info script"

case "$VERPRE" in hsqldb-*);; *)
    Failout  \
"Sorry, but this script requires BASE/VERDIR to be of the form 'hsqldb-VERSION'
  (Yours is '$VERPRE')";;
esac

VER=`echo $VERPRE | sed s:hsqldb-::`

PWD=`pwd`   # Bourne doesn't necessarily set $PWD
SRCBASE=`dirname $PWD`
SRCBASE=`dirname $SRCBASE`
SRCBASE=`dirname $SRCBASE`

[ -f cfg/H*.proto ] ||
 Failout 'You need to fix cfg/H*.proto, or fix the wildcard in this script'

# Be careful if you edit this
echonoterm "Remove old dir package '$PKGNAME'?  "
read REPLY
case "$REPLY" in [Yy]*)
    echonoterm 'Removing old dir package...  '
    rm -rf "./$PKGNAME"
    echo Done;;
    [Qq]*) exit 0;;
esac

echo "Building version $VER with source base $SRCBASE"
pkgmk -o -b $SRCBASE -d . -f cfg/H*.proto || exit 1

echo 'ENTER to quit, Y to build stream package ${PKGNAME}-${VER}.pkg.Z:  '
read REPLY
case "$REPLY" in [Yy]*)
    rm -f "${PKGNAME}-${VER}.pkg" "${PKGNAME}-${VER}.pkg.Z"
    pkgtrans -os . "$PWD/${PKGNAME}-${VER}.pkg" $PKGNAME &&
    echonoterm 'Now compressing... '
    compress "${PKGNAME}-${VER}.pkg"
    echo Done;;
    [Qq]*) exit 0;;
esac
